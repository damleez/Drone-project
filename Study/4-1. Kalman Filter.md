BAYES FILTER, KALMAN FILTER
===
### 1. [Bayes Filter](https://gaussian37.github.io/autodrive-ose-bayes_filter/)
#### - 정의
- Posterior (p(x|z):z가 주어졌을 때의 x) 를 Prior (p(x)) 를 통해서 update 하는 것
  - 이를 SLAM문제를 예로 들면, IMU등으로 추정된 현재 위치 P(x)가 있을 때, 이 값을 LiDAR 또는 Camera로 측정되는 주변환경 정보 관측값을 반영해서 P(X|Z)

![image](https://user-images.githubusercontent.com/108650199/186855475-cfc1fe5d-7667-4969-9f61-e2ca7cddc1e7.png)

- Sensor로 부터 관측되는 sensor observation data z와, 로봇에 전달되는 제어명령 control data u가 있을 때, 로봇의 현재 상태 x (주로 위치, 속도)를 Bayes' Theorem(베이즈정리)에 따라 추정하는 것으로 여기서 t는 현재 time step을 의미
- 따라서 현재시점 xt의 확률분포는 처음부터 현재 시점까지의 (1:t) 연속된 센서 측정값과, 제어명령으로 부터 추정
- for 문의 첫번째 줄 : contorl update 또는 prediction
  - 앞의 예제에서 물리 모델을 통한 예측 부분에 해당하는 알고리즘
  - control update 라고 불리는 이유는 제어값을 사용하여 상태를 업데이트 하였기 때문이고 prediction 이라고 하는 이유는 물리 모델과 제어값을 이용하여 현재 상태를 예측 하였기 때문
- for 문의 두번째 줄 : measurement update 또는 correction
  - 이 부분은 앞의 예제에서 센서값을 통한 예측을 이용하여 현재 상태 보정에 해당하는 알고리즘
  - measurement update 라고 불리는 이유는 센서를 통해 측정한 값을 사용하여 업데이트 하기 때문이고 correction이라고 하는 이유는 prediction한 결과를 센서값을 통하여 보정하기 때문
#### - 한계와 개선 방법

![image](https://user-images.githubusercontent.com/108650199/187107295-36d4416e-fa8a-4885-9e78-365be51ac635.png)

- 한계 : prediction 할 때 사용되는 적분연산
  - 적분 연산은 경우에 따라서 굉장히 연산이 복잡하거나 연산량이 많을 수 있고 심지어 적분이 불가능한 경우 까지 발생
  - Discrete Case인 경우 단순히 ∑으로 합 연산을 하면 되지만 Continuous Case인 경우 반드시 적분 연산을 해야 하기 때문에 계산하는 데 문제가 발생
- 해결 방법
  - 1. 랜덤 샘플링 방식 : 적분이 되지 않는 식을 적분하는 대신 Monte Carlo Integration이란 방법의 랜덤 샘플링 방식을 통하여 근사화 하는 방법 > Particle Filter
  - 2. 가우시안 (정규) 분포 : 적분을 쉽게 할 수 있으면서 적분이 안되는 식을 근사화 하여 사용할 수 있는 확률 분포 > Kalman Filter

     ![image](https://user-images.githubusercontent.com/108650199/187128971-8ec48d80-d426-4e12-883e-4ff462f0ab7f.png)  

     ![image](https://user-images.githubusercontent.com/108650199/187409010-20ea13bc-97d9-41b8-b536-560825acda9e.png)

     - 가우시안 분포는 위 그림과 같이 이미 적분이 다 되어 있어서 어느 영역이든지 적분이 가능
     - 뿐만 아니라 파라미터도 평균과 표준편차만 있어서 다루기 쉬움
     - Bayes Filter의 제어값과 센서값의 노이즈가 정규 분포를 따른다고 가정하고 특히, 노이즈의 평균은 0, 표준편차는 σ를 따른다고 가정
     - 이와 같이 Bayes Filter에서 상태 방정식의 분포 및 노이즈가 가우시안 분포를 따르는 Filter를 Kalman Filter 라고함

### 2. Kalman Filter
#### - 정의
- 칼만 필터(KF, Kalman Filter)는 🌟️선형🌟️ 가우시안 시스템에서 필터링 및 예측을 위한 기술로 시스템의 확률 분포가 Gaussian임
- 칼만 필터는 흔히 노이즈 제거에 사용되며 두 가지 가정을 만족
  - (1) 관찰값이 상태(state)의 현재 함수
  - (2) 다음 상태가 이전 상태의 선형 함수
- 칼만 필터는 물체의 특정 시점에서의 상태가 이전 시점의 상태와 선형적인 관계를 가지고 있는 경우 적용이 가능
  - 즉, 선형 시스템에 대해 뛰어난 성능을 보임
- 따라서, 모바일 로봇의 위치 측위 정확도를 높이기 위하여 칼만 필터를 사용하여 노이즈 제거 및 정확도를 향상
- 칼만 필터는 계산 과정이 네 단계로 되어있지만, 크게 예측과 새로운 측정값을 보정하는 두 단계로 분류되어 설명

- 첫 번째, 예측 단계에서는 시스템 모델과 공분산 행렬을 기반으로 추정 예측값과 오차 공분산 예측값를 계산
  - 윗첨자는 예측값을의미하고, 아래첨자 ‘k’는 시간을 의미
- 두 번째, 업데이트 단계에서는 칼만 이득을 계산 변수는 예측단계에서 구한 값을 사용하며 H는 측정값과 상태 변수의 관계를 나타내는 시스템 모델
  - 이후, 입력된 측정값으로 추정값을 계산
    - 여기서 변수는 예측 단계에서 구한 값을 사용
- 마지막으로 현재 오차 공분산을 계산
  - 오차 공분산은 필터의 추정값의 정확도를 나타냄


#### - [칼만 필터 개념도](https://lovely-embedded.tistory.com/15)

![image](https://user-images.githubusercontent.com/108650199/187126956-b3e0be44-8f7c-4994-91f0-21a7647b7468.png)

##### 변수
|변수이름|측정값|
|------|---|
|Xk|추정값(a posteriori state)|
|Pk|Xk의 오차 공분산|
|Xk-|Xk의 예측값|
|Pk-|Pk의 예측값|

- P : 공분산으로 2개의 확률변수의 상관정도를 나타내는 값'
  - 공분산 : 분산은 스칼라 공분산은 벡터([벡터](https://m.blog.naver.com/PostView.naver?isHttpsRedirect=true&blogId=cjswosa22&logNo=220208729483) : 크기와 방향(성질의 구성요소)를 가짐)
  - 일반적으로 variance라고 하는 분산이 "평균에서 흩어진 정도"를 의미한다면, 공분산은 이 "흩어진 정도"를 n차원에서 표현

  ![image](https://user-images.githubusercontent.com/108650199/187128497-be0214be-94c3-42fc-bcc4-03b8de76156a.png)
  
  - 공분산이 작을수록 더 믿을 수 있는 정보, 공분산이 클수록 믿기 힘든 저보
  - 만약, 2개의 변수 중 하나의 값이 상승하는 경향을 보일 때 다른 값도 상승하는 경향의 상관관계에 있다면 공부산의 값은 양수
  - 반대로 2개의 변수 중 하나의 값이 상승하는 경향을 보일 때, 다른 값이 하강하는 경향을 보인다면 공분산의 값은 음수가 됨
    - Cov(X, Y) > 0    X가 증가 할 때 Y도 증가
    - Cov(X, Y) < 0    X가 증가 할 때 Y는 감소
    - Cov(X, Y) = 0    공분산이 0이라면 두 변수간에는 아무런 선형관계가 없으며 두 변수는 서로 독립적인 관계에 있음을 알 수 있음
                       그러나 두 변수가 독립적이라면 공분산은 0이 되지만, 공분산이 0이라고 해서 항상 독립적이라고 할 수 없음
  - 공분산을 표준편차로 나누게 되면 상관계수가 되며, 두 개의 확률변수 사이의 선형적 관계정도를 나타내는 척도
    - -1 <= Corr(x, y) <= 1 

##### 시스템 모델
|변수이름|측정값|
|------|---|
|A|Xk-1을 통해 추정값을 예측할 때 사용되는 행렬|
|H|Xk-를 측정값의 형태로 변환할 때 필요한 행렬|
|Q|시스템 노이즈|
|R|측정값 노이즈|

- 여기서 A와 H는 상태공간방정식(State space equation)
  - A : x의 변수간 관계를 통해 과거와 현재사이의 물리적인 수식을 행렬로 정리해놓은 것
  - H : x가 위치 속도이고 센서값을 위치로 받고 싶으면 1 0 속도 받고 싶으면 0 1, 즉 센서 진리값을 얻기 위한 상태 공간 방정식
- R과 Q는 Noise
  - 가우시안 분포를 가짐 (왜냐하면, 노이즈 중 많은 경우의 수가 가우시안 분포를 따르기 때문에)

#### - 칼만 필터와 가우시안의 관계

![image](https://user-images.githubusercontent.com/108650199/187409191-48fb7751-91bd-43df-bde8-c6b63935f599.png)

##### 재 풀이
- 예측
  - 첫번째 단계인 예측 과정에서는 이전 단계에서 계산한 추정값Xk-1을 사용하여 시스템 모델A과의 계산을 통해 새로운 추정값을 예측
  - 이때, 예측한 값이 평균을 기준으로 어느 정도로 분포되어 있는지 이전 오차 공분산Pk-1을 사용하여 새로운 오차 공분산Pk-도 함께 예측

- 추정
  - 예측 과정이 끝나게 되면, 칼만 이득을 계산
  - 칼만 이득을 계산할 때는 예측 과정에서 계산한 오차 공분산의 예측값Pk과 측정값의 노이즈R를 사용
  - 추정 과정에서는 추정값과 오차 공분산을 최종적으로 계산
  - 추정 과정에서 추정값을 계산할 때는 예측 과정에서 계산했던 Xk-(추정값의 예측값)과 입력으로 받은 Zk(측정값)을 이용
  - 추정값의 계산식은 예측 과정에서 구한 Xk-에 Zk와 Xk-의 차이를 보상하여(더하여) 계산
  - 이때, 칼만 이득이 사용되는데 바로 Zk와 Xk-의 차이(Zk-Xk-)의 결과에 영향을 미침
  - 칼만이득은 Xk와 같은 추정값의 계산식에서 zk-xk-값을 조절하여 xk에 더해주게 됨
    - 칼만이득은 가중치라고 생각하면 됨
    - R (센서 노이즈 증가) > Kalman gain K 감소 > 최종 추정값에서 센서에 대한 비중 축소
    - Q (시스템 노이즈 증가) > Kalman gain K 증가 > 최종 추정값에서 센서에 대한 비중 확대

